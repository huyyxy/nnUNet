# 基于区域的训练

## 这是什么？
在一些分割任务中，最典型的是[脑肿瘤分割挑战赛](http://braintumorsegmentation.org/)，用于评估指标的目标区域与训练数据中提供的标签并不一致。出现这种情况，是因为在部分临床应用中，与其分别检测水肿、坏死和非增强肿瘤、增强肿瘤等单独标签，更重要的是识别整个肿瘤、肿瘤核心以及增强肿瘤等区域。

<img src="assets/regions_vs_labels.png" width="768px" />

上图展示了一个 BraTS 案例，上方是基于标签的任务表示，下方是基于区域的表示。挑战赛的评估基于区域进行。如我们在[BraTS 2018 的工作](https://arxiv.org/abs/1809.10483)中所示，直接对这些重叠区域而不是单独标签进行优化能够得到得分更高的模型！

## nnU-Net 能做什么？
nnU-Net 的基于区域训练允许通过合并单独标签来学习区域。对某些分割任务而言，这会带来好处，因为它在训练过程中重新分配了不同标签的重要性。尤为突出的是，这个特性可用于表示**层次化类别**，例如当需要同时分割器官及其子结构时。想象一个肝脏分割问题，同时还需分割血管和肿瘤。第一个目标区域可以是整个肝脏（包含子结构），其余目标则是各个子结构。

重要提示：nnU-Net 仍然需要整数标签图作为输入，并生成整数标签图作为输出！基于区域的训练可以用来学习重叠标签，但前提是必须存在某种方式来建模这些重叠（下面会介绍 nnU-Net 如何实现这一点）。

## 如何使用？

在 `dataset.json` 中声明标签时，BraTS 通常是这样的：

```python
...
"labels": {
    "background": 0,
    "edema": 1,
    "non_enhancing_and_necrosis": 2,
    "enhancing_tumor": 3
},
...
```
（我们使用与挑战赛不同的整数值，因为 nnU-Net 需要连续的整数！）

这种表示方式对应于上图的上方那一行。

若要进行基于区域的训练，需要将标签改成如下形式：

```python
...
"labels": {
    "background": 0,
    "whole_tumor": [1, 2, 3],
    "tumor_core": [2, 3],
    "enhancing_tumor": 3  # 或 [3]
},
"regions_class_order": [1, 2, 3],
...
```
这对应于上图的下方那一行。请注意，`dataset.json` 中需要新增一个条目：`regions_class_order`。它告诉 nnU-Net 如何将区域表示重新转换为整数标签图。本质上，它指定了 nnU-Net 应该以什么顺序、在各个区域上放置哪些标签。该列表的长度必须与区域数量（不含背景）一致。列表中每个元素对应于最终分割中用来替换该区域的标签。后面的条目会覆盖前面的条目！具体而言，在这个例子中，nnU-Net 会先在预测的 `whole_tumor` 区域中放置标签 1（水肿），然后在预测的 `tumor_core` 区域放置标签 2（非增强肿瘤和坏死），最后在预测的 `enhancing_tumor` 区域放置标签 3。在每一步中，先前设置的像素会被新标签覆盖！因此在设置 `regions_class_order` 时，请先放置包含型区域（例如 whole_tumor 等），再放子结构。

**重要提示**：由于将区域转换回分割图时对区域声明顺序非常敏感（“把标签 X 放在第一个区域”），必须确保这个顺序不会被改变！如果是自动生成 `dataset.json`，要确保字典键不会被按字母顺序排序！在 `json.dump()` 中设置 `sort_keys=False`！

nnU-Net 会在区域级别（而不是单独标签）执行评估和模型选择！

就这样，简单吧？